---
export type CarouselItem = {
  src: string;
  alt?: string;
  title: string;
  subTitle?: string;
  description?: string;
  href: string;
};

type Props = {
  items: CarouselItem[];
  initialIndex?: number;
};

const { items, initialIndex = 0 } = Astro.props;

if (!items?.length) {
  throw new Error("[Carrousel] La prop `items` est requise et doit contenir au moins 1 élément.");
}
---

<div
  class="carousel"
  data-carousel
  data-items={JSON.stringify(items)}
  data-initial-index={String(initialIndex)}
  role="region"
  aria-label="Carrousel"
  tabindex="0"
>
  <div class="carousel__viewport" aria-live="polite">
    <button
      class="carousel__btn carousel__btn--prev"
      type="button"
      data-prev
      aria-label="Précédent"
    >
      ‹
    </button>

    <button
      class="carousel__btn carousel__btn--next"
      type="button"
      data-next
      aria-label="Suivant"
    >
      ›
    </button>

    {items.map((it, i) => (
      <a
        class="carousel__slide"
        href={it.href}
        data-slide
        data-index={i}
        aria-label={it.title}
      >
        <img
          class="carousel__img"
          src={it.src}
          alt={it.alt ?? it.title}
          loading="lazy"
          draggable="false"
        />
      </a>
    ))}
  </div>

  <div class="carousel__meta">
    <h3 class="carousel__title" data-title></h3>
    <p class="carousel__subtitle" data-subtitle></p>
    <p class="carousel__desc" data-desc></p>
  </div>
</div>

<style>
  .carousel {
    width: 100%;
    height: 100%;              /* <-- remplit la colonne droite */
    user-select: none;

    display: flex;             /* <-- viewport + texte en colonne */
    flex-direction: column;
    justify-content: center;   /* <-- centre verticalement dans la section */
    gap: 0.75rem;

    outline: none;
  }

  .carousel__viewport {
    position: relative;
    height: 15rem;
    width: 100%;
    overflow: hidden;
    display: grid;
    place-items: center;
  }

  /* Boutons (AU-DESSUS des slides) */
  .carousel__btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10; /* <-- clé: devant les images */

    width: 2.25rem;
    height: 2.25rem;
    border-radius: 9999px;

    border: 1px solid rgba(255, 255, 255, 0.35);
    background: rgba(0, 0, 0, 0.35);
    color: white;

    display: grid;
    place-items: center;

    cursor: pointer;
    pointer-events: auto;

    transition: background-color 160ms ease-out, transform 160ms ease-out;
  }

  .carousel__btn--prev { left: 0.5rem; }
  .carousel__btn--next { right: 0.5rem; }

  .carousel__btn:hover {
    background: rgba(0, 0, 0, 0.55);
    transform: translateY(-50%) scale(1.05);
  }

  .carousel__btn:focus-visible {
    outline: 2px solid rgba(255, 255, 255, 0.85);
    outline-offset: 2px;
  }

  /* Slides: se chevauchent */
  .carousel__slide {
    position: absolute;
    top: 50%;
    left: 50%;

    width: 15rem;
    height: 15rem;

    transform: translate(-50%, -50%) scale(0.9);
    opacity: 0;
    z-index: 1;

    pointer-events: none;
    transition:
      transform 220ms cubic-bezier(0, 0, 0.2, 1),
      opacity 220ms cubic-bezier(0, 0, 0.2, 1);
  }

  .carousel__slide.is-active {
    opacity: 1;
    z-index: 3;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
  }

  .carousel__slide.is-prev {
    opacity: 0.7;
    z-index: 2;
    pointer-events: auto;
    transform: translate(calc(-50% - 55%), -50%) scale(0.92);
  }

  .carousel__slide.is-next {
    opacity: 0.7;
    z-index: 2;
    pointer-events: auto;
    transform: translate(calc(-50% + 55%), -50%) scale(0.92);
  }

  /* Hover scale 1.05 */
  .carousel__img {
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 0.5rem;
    object-fit: cover;

    transform: scale(1);
    transition: transform 200ms cubic-bezier(0, 0, 0.2, 1);
  }

  .carousel__slide.is-active:hover .carousel__img,
  .carousel__slide.is-prev:hover .carousel__img,
  .carousel__slide.is-next:hover .carousel__img,
  .carousel__slide.is-active:focus-visible .carousel__img,
  .carousel__slide.is-prev:focus-visible .carousel__img,
  .carousel__slide.is-next:focus-visible .carousel__img {
    transform: scale(1.05);
  }

  .carousel__meta {
    text-align: center;
  }

  .carousel__title {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 700;
  }

  .carousel__subtitle {
    margin: 0.25rem 0 0;
    opacity: 0.85;
    font-style: italic;
  }

  .carousel__desc {
    margin: 0.5rem auto 0;
    max-width: 60ch;
    opacity: 0.9;
  }

  @media (prefers-reduced-motion: reduce) {
    .carousel__slide,
    .carousel__img,
    .carousel__btn {
      transition: none;
    }
  }
</style>

<script is:inline>
  (() => {
    const roots = Array.from(document.querySelectorAll("[data-carousel]"));
    if (!roots.length) return;

    const mod = (n, m) => ((n % m) + m) % m;

    roots.forEach((root) => {
      const items = JSON.parse(root.getAttribute("data-items") || "[]");
      const slides = Array.from(root.querySelectorAll("[data-slide]"));

      const prevBtn = root.querySelector("[data-prev]");
      const nextBtn = root.querySelector("[data-next]");

      const titleEl = root.querySelector("[data-title]");
      const subtitleEl = root.querySelector("[data-subtitle]");
      const descEl = root.querySelector("[data-desc]");

      let index = Number(root.getAttribute("data-initial-index") || 0) || 0;

      function render() {
        const n = items.length;
        if (!n) return;

        index = mod(index, n);
        const prev = mod(index - 1, n);
        const next = mod(index + 1, n);

        slides.forEach((el, i) => {
          el.classList.remove("is-prev", "is-active", "is-next");
          if (i === index) el.classList.add("is-active");
          else if (i === prev) el.classList.add("is-prev");
          else if (i === next) el.classList.add("is-next");
        });

        const it = items[index];
        if (titleEl) titleEl.textContent = it?.title ?? "";
        if (subtitleEl) subtitleEl.textContent = it?.subTitle ?? "";
        if (descEl) descEl.textContent = it?.description ?? "";
      }

      function go(delta) {
        index = mod(index + delta, items.length);
        render();
      }

      slides.forEach((el, i) => {
        el.addEventListener("click", (e) => {
          if (i !== index) {
            e.preventDefault();
            index = i;
            render();
          }
        });
      });

      prevBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        go(-1);
      });

      nextBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        go(+1);
      });

      render();
    });
  })();
</script>
